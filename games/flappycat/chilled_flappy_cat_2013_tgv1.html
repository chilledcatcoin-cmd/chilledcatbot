<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Flappy Cat — A Chilled Cat Game</title>
<script src="https://download.playfab.com/PlayFabClientApi.js"></script>
</head>
<body>
<canvas id="game"></canvas>
<div id="ovOver" class="overlay">
  <div class="panel">
    <h2>Game Over</h2>
    <p>Final score: <b id="finalScore">0</b></p>
    <button id="btnRestart">Restart</button>
    <div class="lb">
      <h3>🏆 Top 10</h3>
      <ol id="lbList"></ol>
      <div id="lbStatus" style="font-size:12px;color:#666"></div>
    </div>
  </div>
</div>

<script>
(() => {
const params = new URLSearchParams(location.search);
const uid = params.get("uid") || crypto.randomUUID();
const username = params.get("username") || "";
const firstName = params.get("first_name") || "";
const playFabTitleId = "B4195";
PlayFab.settings.titleId = playFabTitleId;

PlayFabClientSDK.LoginWithCustomID({
  TitleId: playFabTitleId,
  CustomId: uid,
  CreateAccount: true
}, (res) => {
  const displayName = username || firstName || ("Player_" + uid.slice(0,6));
  PlayFabClientSDK.UpdateUserTitleDisplayName({ DisplayName: displayName },
    () => console.log("✅ Display name set:", displayName),
    (err) => console.error("❌ Failed to set display name:", err)
  );
}, (err) => console.error("❌ Login failed", err));

function saveScore(score){
  PlayFabClientSDK.UpdatePlayerStatistics({
    Statistics:[{StatisticName:"HighScore",Value:score}]
  }, () => loadLeaderboard(), (err)=>console.error("Save error",err));
}

function loadLeaderboard(){
  const list=document.getElementById("lbList");
  const status=document.getElementById("lbStatus");
  list.innerHTML=""; status.textContent="Loading…";
  PlayFabClientSDK.GetLeaderboard({
    StatisticName:"HighScore", StartPosition:0, MaxResultsCount:10
  }, (res)=>{
    list.innerHTML=""; status.textContent="";
    res.data.Leaderboard.forEach((entry,i)=>{
      const li=document.createElement("li");
      li.textContent = `${i+1}. ${entry.DisplayName || "Anonymous"} — ${entry.StatValue}`;
      list.appendChild(li);
    });
  }, (err)=>{status.textContent="Error"; console.error(err);});
}

// Demo game loop (replace with real game logic)
let score=0; let state="playing";
function die(){state="dead";document.getElementById("finalScore").textContent=score;
document.getElementById("ovOver").classList.add("show"); saveScore(score);}
document.getElementById("btnRestart").onclick=()=>{score=0;state="playing";
document.getElementById("ovOver").classList.remove("show");};
setInterval(()=>{if(state==="playing"){score++; if(score>5)die();}},1000);
})();
</script>
</body>
</html>
