<!DOCTYPE html>
<!--
/**
 *
 *    _______   .---.  .---..-./`)   .---.     .---.       .-''-.   ______     
 *   /   __  \  |   |  |_ _|\ .-.')  | ,_|     | ,_|     .'_ _   \ |    _ `''. 
 *  | ,_/  \__) |   |  ( ' )/ `-' \,-./  )   ,-./  )    / ( ` )   '| _ | ) _  \
 *,-./  )       |   '-(_{;}_)`-'`"`\  '_ '`) \  '_ '`) . (_ o _)  ||( ''_'  ) |
 *\  '_ '`)     |      (_,_) .---.  > (_)  )  > (_)  ) |  (_,_)___|| . (_) `. |
 * > (_)  )  __ | _ _--.   | |   | (  .  .-' (  .  .-' '  \   .---.|(_    ._) '
 *(  .  .-'_/  )|( ' ) |   | |   |  `-'`-'|___`-'`-'|___\  `-'    /|  (_.\.' / 
 * `-'`-'     / (_{;}_)|   | |   |   |        \|        \\       / |       .'  
 *   `._____.'  '(_,_) '---' '---'   `--------``--------` `'-..-'  '-----'`    
 *                                                                           
 *                   +=*          ***	    _______      ____   ,---------. 			              
 *                  *:::*        *=.:*	   /   __  \   .'  __ `.\          \	             
 *                 *.::::+      *:.:::*     | ,_/  \__) /   '  \  \`--.  ,---'         
 *                 +....+*++**++::::::=*  ,-./  )       |___|  /  |   |   \       
 *               *+++=:.:::::.:..:.::::*  \  '_ '`)        _.-`   |   :_ _:            
 *                ++++=--=+=-+:=+++++++=+  > (_)  )  __ .'   _    |   (_I_)        
 *               *:+..##.:++::+++***=++*  (  .  .-'_/  )|  _( )_  |  (_(=)_)   
 *               *..*....-+:::++..#:..=+   `-'`-'     / \ (_ o _) /   (_I_)   
 *               *........+::.+.:++*+..*     `._____.'   '.(_,_).'    '---'
 *               *...*+:.:::::-....:...+           
 *               *....*....:=.....::...**:**=*     
 *               *.....+=...+...-:....-*::+=:+*-*  
 *                +....+**+**+****.:=+*+.=*:=*.:*  
 *              **+....=-:####%:+...*.+::::.*=:*   
 *           *:..=*++=..:+=:::=*....*...*::..:*    
 *         *+.:+......:+.......:+*-:=+.......*     
 *         *.=-........:=............:+:...:**     [ chilled cat warez ]       /\_/\         
 *        *:-=...=...*.++.............*::::*.*     nfo: vibes ‚Ä¢ meow ‚Ä¢ zzz    ( o.o )        
 *        *.*....*::.**:.............*-.:::+.*     rel: 1997 // TON forever    > ^ <         
 *        *:=....=**+:...........::..*.....+:*     
 *        **.....+*::=+::.::.....:*:**..:..+:*     
 *        **.....+:-+*:.:+::::**:-=::+.....+:*     
 *
 * =====================================================
 *  Flappy Cat ‚Äî A Chilled Cat Game
 *   Version: 1.2.0
 *   Date: 2025-10-01
 *   Author: Chilled Cat Team
 *  
 *   Changelog:
 *   v1.2.0 - Added PlayFab DisplayName fallback, bugfixes
 *   v1.1.0 - Integrated PlayFab leaderboards
 *   v1.0.0 - Initial release with game loop + start screen
 * =====================================================
 */
-->

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Flappy Cat ‚Äî A Chilled Cat Game</title>
<link rel="icon" type="./image/png" href="./images/favicon.png">
<style>
  :root { --bg1:#bfeaff; --bg2:#86c6ff; --pipe:#3cb043; --ground:#7c5b3a; --grass:#7ed957; --ui:#111; }
  html,body{margin:0;height:100%;background:var(--bg2);font-family:system-ui;color:var(--ui);overflow:hidden}
  .wrap{display:flex;justify-content:center;align-items:center;height:100%}
  canvas{
    image-rendering:pixelated;
    background:linear-gradient(var(--bg1), var(--bg2) 70%);
    border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.2)
  }

  .hud{position:fixed;inset:0;display:grid;place-items:start center;pointer-events:none}
  .topbar{pointer-events:auto;position:absolute;top:10px;right:10px;background:#ffffffb3;padding:6px 10px;border-radius:999px}
  .btn{border:0;background:#222;color:#fff;padding:6px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .scorebox{pointer-events:auto;position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:#ffffffe6;padding:8px 14px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.15);font-weight:900}

  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:auto}
  .overlay.show{display:flex}
  .panel{width:min(420px,90vw);background:#fffffff2;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.25);padding:18px;text-align:center}
  .titleWrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:8px}
  .logoCat{width:min(260px,55vw);height:auto;display:block}
  .gameTitle{font-size:32px;font-weight:900;color:#0b3b8f;text-shadow:0 2px 8px #0002;letter-spacing:.5px;margin:0}
  .sub{font-size:14px;color:#333;margin:0 0 6px}
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}

  .lb{margin-top:12px;text-align:left;background:#f7f9ff;border:1px solid #e4e9ff;border-radius:12px;padding:10px}
  .lb h3{margin:0 0 6px;font-size:16px}
  .lb ol{margin:0;padding-left:22px}
  .muted{color:#666;font-size:13px}

#contestTimer { color: #0a0; font-size: 14px; }

.timer {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #000000b3;
  color: #fff;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 700;
  font-family: monospace;
  font-size: 14px;
}

  @media (max-width: 480px){
    .gameTitle{font-size:26px}
  }
</style>
<script src="https://download.playfab.com/PlayFabClientApi.js"></script>
</head>
<body>
  <div class="wrap"><canvas id="game"></canvas></div>

  <div class="hud">
    <div class="topbar"><button id="btnMute" class="btn">üîä</button></div>
    <div id="contestTimer" class="timer" style="display:none"></div>
    <div id="scorebox" class="scorebox">Score: <span id="score">0</span></div>

    <div id="ovStart" class="overlay show">
      <div class="panel">
        <div class="titleWrap">
          <img class="logoCat" src="./images/chilled_cat_fappy.png" alt="Flappy Cat">
          <h1 class="gameTitle">CHILLED FLAPPY CAT</h1>
          <p class="sub">Tap screen or press Space to flap</p>
        </div>
        <div class="row"><button id="btnStart" class="btn">Start</button></div>
      </div>
    </div>

    <div id="ovOver" class="overlay">
      <div class="panel">
        <div class="titleWrap" style="margin-bottom:4px">
          <img class="logoCat" src="./images/bonk.png" alt="Bonk">
          <h2 class="gameTitle" style="font-size:24px">Game Over</h2>
          <p class="sub">Final score: <b id="finalScore">0</b></p>
        </div>
        <div class="row"><button id="btnRestart" class="btn">Restart</button></div>
        <div class="lb">
          <h3>üèÜ Top 10</h3>
          <ol id="lbList"></ol>
          <div id="lbStatus" class="muted" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(()=>{
/* ---------- PlayFab Setup ---------- */
/* ---------- PlayFab Setup ---------- */
const playFabTitleId = "B4195";
PlayFab.settings.titleId = playFabTitleId;

// üîπ Parse URL parameters
const params = new URLSearchParams(location.search);

// üîπ Decode Telegram user info sent from the bot
let user = {};
try {
  user = JSON.parse(decodeURIComponent(params.get("user") || "{}"));
} catch {
  user = {};
}

// üîπ Build identifiers for PlayFab
const uid = user.id ? String(user.id) : crypto.randomUUID();
const username = user.first_name || user.username || "Anonymous";
const contestKey = params.get("contest"); // active contest leaderboard key


let contestActive = true;
const endTime = parseInt(params.get("end") || "0");

if (contestKey && endTime) {
  const timerBox = document.getElementById("contestTimer");
  timerBox.style.display = "block";

  const updateTimer = () => {
    const remaining = endTime - Date.now();
    const sb = document.getElementById("scorebox");

    if (remaining <= 0) {
      if (contestActive) {
        contestActive = false;

        // Change score box color + label safely
        const currentScore = window.score || 0;
        sb.style.background = "#ffd6d6";
        sb.style.border = "2px solid #d00";
        sb.innerHTML = "üèÅ Contest Ended ‚Äî Score: <span id='score'>" + currentScore + "</span>";

        // Add a small floating banner on top
        const banner = document.createElement("div");
        banner.textContent = "üèÅ Contest Ended ‚Äî Scores no longer count";
        banner.style.position = "absolute";
        banner.style.top = "0";
        banner.style.left = "0";
        banner.style.right = "0";
        banner.style.background = "#d00";
        banner.style.color = "#fff";
        banner.style.fontWeight = "bold";
        banner.style.textAlign = "center";
        banner.style.padding = "6px 0";
        banner.style.zIndex = "9999";
        banner.style.pointerEvents = "none";
        document.body.appendChild(banner);

        // Fade out after 10 seconds
        setTimeout(() => {
          banner.style.transition = "opacity 1s ease";
          banner.style.opacity = "0";
          setTimeout(() => banner.remove(), 1000);
        }, 10000);
      }

      timerBox.textContent = "üèÅ Contest Over!";
      timerBox.style.color = "#c00";
      return;
    }

    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    timerBox.textContent = `‚è≥ ${mins}m ${secs}s remaining`;
  };

  // Run immediately and every second
  updateTimer();
  setInterval(updateTimer, 1000);
}


const contestEnd = Number(params.get("end") || 0);
const isContest = Boolean(contestKey && contestEnd);

// üèÅ Highlight contest mode if active
if (contestKey) {
  const sb = document.getElementById("scorebox");
  sb.style.background = "#fff2b3";
  sb.style.border = "2px solid #e2b600";
  sb.innerHTML = "üèÅ Contest Mode ‚Äî Score: <span id='score'>0</span>";
}

// ‚úÖ Initialize Telegram WebApp if running inside Telegram
if (window.Telegram && window.Telegram.WebApp) {
  try {
    window.Telegram.WebApp.ready();
    console.log("üì± Telegram WebApp ready");
  } catch (e) {
    console.warn("‚ö†Ô∏è Telegram ready() skipped:", e);
  }
}

PlayFabClientSDK.LoginWithCustomID({
  TitleId: playFabTitleId,
  CustomId: uid,
  CreateAccount: true
}, () => {
  console.log("‚úÖ PlayFab login OK");

  // Try setting display name, but don‚Äôt block init if it fails
PlayFabClientSDK.UpdateUserTitleDisplayName({
  DisplayName: username
}, res => {
  if (res && res.data) {
    console.log("‚úÖ DisplayName set:", res.data.DisplayName);
  }
  initGame();
}, err => {
  console.warn("‚ö†Ô∏è Couldn‚Äôt set DisplayName:", err);

  if (err.error === "NameNotAvailable") {
    // fallback: append uid fragment so it's unique
    const fallback = (username || "Player") + "_" + uid.slice(-4);
    console.log("‚ÑπÔ∏è Retrying with fallback name:", fallback);

    PlayFabClientSDK.UpdateUserTitleDisplayName({
      DisplayName: fallback
    }, res2 => {
      if (res2 && res2.data) {
        console.log("‚úÖ Fallback DisplayName set:", res2.data.DisplayName);
      }
      initGame();
    }, err2 => {
      console.error("‚ùå Fallback name failed too:", err2);
      initGame();
    });
  } else {
    initGame(); // always continue even if another error
  }
});



}, err => {
  console.error("‚ùå PlayFab login failed:", err);
  initGame(); // still run game offline
});

function initGame() {
/* ---------- sizing & canvas ---------- */
const isMobile=/Mobi|Android/i.test(navigator.userAgent);
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
const DPR=Math.max(1,Math.floor(window.devicePixelRatio||1));
let VW=480,VH=720;
function fit(){const vw=window.innerWidth,vh=window.innerHeight,aspect=3/2;let tw=vw,th=tw*aspect;if(th>vh){th=vh;tw=th/aspect;}VW=tw;VH=th;canvas.style.width=VW+'px';canvas.style.height=VH+'px';canvas.width=Math.floor(VW*DPR);canvas.height=Math.floor(VH*DPR);ctx.setTransform(DPR,0,0,DPR,0,0);}
fit(); addEventListener('resize',fit);

/* ---------- audio ---------- */
let muted=false,audioCtx;
function initAudio(){if(!audioCtx){try{audioCtx=new (window.AudioContext||window.webkitAudioContext)();}catch{}}}
function beep(f=880,d=0.05,t='sine',v=0.1){if(muted||!audioCtx)return;try{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}catch{}}
document.getElementById('btnMute').onclick=()=>{muted=!muted;document.getElementById('btnMute').textContent=muted?'üîà':'üîä'}

/* ---------- wake lock ---------- */
let wakeLock=null;
async function requestWakeLock(){if('wakeLock' in navigator){try{wakeLock=await navigator.wakeLock.request('screen');document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'&&!wakeLock)requestWakeLock();});}catch(e){}}}

/* ---------- game state ---------- */
const G=1200,FLAP=420,PIPE_GAP_MIN=150,PIPE_GAP_MAX=210,PIPE_W=70,PIPE_SPACING=220,PIPE_SPEED=160,GROUND_H=60;
let tPrev=0,acc=0,dtFixed=1/120,state='start',score=0;
const catImg=new Image();catImg.src='./images/chilled_cat_fappy.png';let catImgReady=false;catImg.onload=()=>catImgReady=true;
const cat={x:120,y:200,vy:0,r:28,rot:0};const pipes=[];
function updateScore(){document.getElementById('score').textContent=score;}
function spawnPipes(initial=false){const bx=initial?VW+100:Math.max(VW+10,(pipes.at(-1)?.x||0)+PIPE_SPACING);const gap=PIPE_GAP_MIN+Math.random()*(PIPE_GAP_MAX-PIPE_GAP_MIN);const m=80;const top=m+Math.random()*(VH-GROUND_H-m*2-gap);pipes.push({x:bx,w:PIPE_W,top,gap,passed:false});}
function fullyReset(){score=0;updateScore();state='playing';cat.x=120;cat.y=VH/2-60;cat.vy=0;cat.rot=0;pipes.length=0;spawnPipes(true);}
function startGame(){document.getElementById('ovStart').classList.remove('show');fullyReset();requestWakeLock();}

/* ---------- input ---------- */
if(isMobile){canvas.addEventListener('touchstart',e=>{initAudio();e.preventDefault();if(state==='start'||state==='dead'){startGame();return;}if(state==='playing'){cat.vy=-FLAP;beep(520,0.05,'square',0.06);}}, {passive:false});}
else{addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();initAudio();if(state==='start'||state==='dead'){startGame();return;}if(state==='playing'){cat.vy=-FLAP;beep(520,0.05,'square',0.06);}}});canvas.addEventListener('click',e=>{initAudio();e.preventDefault();if(state==='start'||state==='dead'){startGame();return;}if(state==='playing'){cat.vy=-FLAP;beep(520,0.05,'square',0.06);}});}
document.getElementById('btnStart').onclick=()=>{initAudio();startGame();};

/* ---------- restart ---------- */
document.getElementById('btnRestart').onclick=()=>{document.getElementById('ovOver').classList.remove('show');fullyReset();};

/* ---------- physics / loop ---------- */
function step(dt){if(state!=='playing')return;cat.vy+=G*dt;cat.y+=cat.vy*dt;cat.rot=Math.atan2(cat.vy,PIPE_SPEED)*0.8;for(const p of pipes)p.x-=PIPE_SPEED*dt;if(!pipes.length||(VW-(pipes.at(-1)?.x||0))>PIPE_SPACING)spawnPipes();while(pipes.length&&pipes[0].x+pipes[0].w<-50)pipes.shift();for(const p of pipes){if(!p.passed&&cat.x>p.x+p.w){p.passed=true;score++;updateScore();beep(800,0.04,'triangle',0.06);}if(hitPipe(p))return die();}if(cat.y+cat.r>VH-GROUND_H||cat.y-cat.r<0)return die();}
function hitPipe(p){return circleRect(cat.x,cat.y,cat.r,p.x,0,p.w,p.top)||circleRect(cat.x,cat.y,cat.r,p.x,p.top+p.gap,p.w,VH-GROUND_H-(p.top+p.gap));}
function die(){
  if(state==='dead') return;
  state='dead';
  beep(220,0.2,'sawtooth',0.08);
  document.getElementById('finalScore').textContent=String(score);
  document.getElementById('ovOver').classList.add('show');

  // Fetch player‚Äôs current high score before overwriting (global)
  PlayFabClientSDK.GetPlayerStatistics({}, res => {
    const prev = res.data.Statistics.find(s=>s.StatisticName==="FlappyCatScore")?.Value || 0;
    const statsToSave = [];

    if (score > prev) {
      statsToSave.push({ StatisticName:"FlappyCatScore", Value: score });
    }

if (contestKey) {
  // üèÅ If contest has expired, don't save
  if (!contestActive) {
    console.log("üèÅ Contest over ‚Äî skipping contest score save");
  } else {
    const prevContest = res.data.Statistics.find(s => s.StatisticName === contestKey)?.Value || 0;
    if (score > prevContest) {
      statsToSave.push({ StatisticName: contestKey, Value: score });
    } else {
      console.log("‚ÑπÔ∏è Contest score not higher, skipping update");
    }
  }
}



    if (statsToSave.length > 0) {
      PlayFabClientSDK.UpdatePlayerStatistics({ Statistics: statsToSave }, () => {
        console.log("‚úÖ Scores saved:", statsToSave);
        renderLeaderboard();
      }, err=>console.error("‚ùå Error saving score:",err));
    } else {
      console.log("‚ÑπÔ∏è Score not higher, skipping update");
      renderLeaderboard(); 
    }
  }, err=>{
    console.error("‚ùå Could not fetch player stats", err);
    renderLeaderboard();
  });
}

function renderLeaderboard(){
  const status = document.getElementById("lbStatus");
  const list = document.getElementById("lbList");
  list.innerHTML = "";
  status.style.display = "block";
  status.textContent = "Loading‚Ä¶";

  const statName = contestKey ? contestKey : "FlappyCatScore";

  PlayFabClientSDK.GetLeaderboard({
    StatisticName: statName,
    StartPosition: 0,
    MaxResultsCount: 10
  }, res => {
    status.style.display = "none";
    list.innerHTML = "";
    if (!res.data || !res.data.Leaderboard.length) {
      list.innerHTML = "<li>No scores yet</li>";
      return;
    }

    res.data.Leaderboard.forEach(entry => {
      let name = entry.DisplayName;
      if (!name || /^\d+$/.test(name)) {
        name = "Anonymous";
      }
      const li = document.createElement("li");
      li.textContent = `${name}: ${entry.StatValue}`;
      list.appendChild(li);
    });

  }, err => {
    status.textContent = "‚ùå Error loading scores";
    console.error("Leaderboard error:", err);
  });
}



/* ---------- helpers ---------- */
function circleRect(cx,cy,cr,rx,ry,rw,rh){const tx=Math.max(rx,Math.min(cx,rx+rw));const ty=Math.max(ry,Math.min(cy,ry+rh));const dx=cx-tx,dy=cy-ty;return dx*dx+dy*dy<=cr*cr;}
function draw(){for(const p of pipes)drawPipe(p);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--grass');ctx.fillRect(0,VH-GROUND_H,VW,20);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--ground');ctx.fillRect(0,VH-GROUND_H+20,VW,GROUND_H-20);ctx.save();ctx.translate(cat.x,cat.y);ctx.rotate(cat.rot);if(catImgReady){ctx.drawImage(catImg,-36,-36,72,72);}else{ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,28,0,Math.PI*2);ctx.fill();}ctx.restore();if(state==='playing'){ctx.fillStyle='rgba(255,255,255,.85)';ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=6;ctx.font='900 56px system-ui';ctx.textAlign='center';ctx.strokeText(String(score),VW/2,90);ctx.fillText(String(score),VW/2,90);}}
function drawPipe(p){const col=getComputedStyle(document.documentElement).getPropertyValue('--pipe');ctx.fillStyle=col;ctx.fillRect(p.x,0,p.w,p.top);ctx.fillRect(p.x-4,p.top-16,p.w+8,16);const by=p.top+p.gap;ctx.fillRect(p.x,by,p.w,VH-GROUND_H-by);ctx.fillRect(p.x-4,by,p.w+8,16);}
function loop(t){const now=t/1000,dt=tPrev?Math.min(0.05,now-tPrev):0;tPrev=now;if(state==='playing'){acc+=dt;while(acc>=dtFixed){step(dtFixed);acc-=dtFixed;}}ctx.clearRect(0,0,VW,VH);draw();requestAnimationFrame(loop);}requestAnimationFrame(loop);
document.getElementById('ovStart').classList.add('show');
}
})();
</script>
</body>
</html>
