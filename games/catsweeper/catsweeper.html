<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CatSweeper ‚Äô97 ‚Äî Chilled Cat Minesweeper</title>
<style>
  :root{ --tile: 28px; --gap: 2px; }
  body{margin:0;background:#0a1a2f;color:#fff;font-family:Verdana,sans-serif;}
  .wrap{max-width:980px;margin:10px auto;padding:8px}
  .card{background:#112244;border:4px ridge #88a;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.4)}
  .titlebar{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#003377;border-bottom:3px groove #88a}
  .titlebar h1{margin:0;font-size:18px}
  .panel{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:8px 10px}
  .group{display:flex;align-items:center;gap:8px}
  .btn{border:3px outset #bdf;background:#0d5bd1;color:#fff;padding:6px 12px;cursor:pointer;border-radius:6px;font-weight:800}
  .btn:active{border-style:inset}
  select{background:#002a59;color:#fff;border:2px solid #7fc0ff;border-radius:6px;padding:4px 8px}
  .stat{font-weight:700}
  .stat b{color:#ffe066}
  .board-wrap{padding:10px;display:grid;place-items:center;overflow:hidden}
  .board{display:grid;gap:var(--gap);background:#001d3d;padding:var(--gap);border:4px groove #88a;border-radius:6px;user-select:none}
  .cell{width:var(--tile);height:var(--tile);display:grid;place-items:center;font-weight:800;font-size:14px;line-height:1;border-radius:4px;cursor:pointer}
  .cell.hidden{background:#0f3a75;border:2px outset #a9d2ff}
  .cell.revealed{background:#0a2244;border:2px inset #7fb5ff;cursor:default}
  .cell.mine{background:#3b0a1b}
  .num1{color:#7effad}.num2{color:#b1e3ff}.num3{color:#ffd18d}.num4{color:#ff9aa2}
  .num5{color:#ffa3ff}.num6{color:#c4ffd9}.num7{color:#fff}.num8{color:#d6e2ff}
  .cell.pressed{box-shadow:inset 0 0 6px #ffe066,0 0 6px #ffe066;transition:box-shadow .15s ease}
  .cell.chorded{animation:chordFlash .3s ease}
  @keyframes chordFlash{0%{background:#ffe066}100%{background:#0a2244}}
  .footer{padding:6px 10px;text-align:center;font-size:12px;opacity:.85}
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.75)}
  .overlay.show{display:grid}
  .modal{background:#163258;padding:16px;border-radius:10px;width:min(92vw,420px);text-align:center}
  .btnRow{display:flex;gap:10px;justify-content:center;margin-top:8px}
  ol{padding-left:20px;text-align:left}
</style>
<script src="https://telegram.org/js/games.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="titlebar"><h1>üêæ CatSweeper ‚Äô97</h1></div>
      <div class="panel">
        <div class="group">
          <label>Difficulty
            <select id="difficulty">
              <option value="b">Beginner (9√ó9 ¬∑ 10)</option>
              <option value="i">Intermediate (16√ó16 ¬∑ 40)</option>
              <option value="e">Expert (30√ó16 ¬∑ 99)</option>
            </select>
          </label>
          <button class="btn" id="newGame">New Game</button>
        </div>
        <div class="group">
          <div class="stat">‚è±Ô∏è Time: <b id="time">0.0</b>s</div>
          <div class="stat">üèÅ Flags: <b id="flags">0</b></div>
          <div class="stat">üòº Safe: <b id="remaining">0</b></div>
        </div>
      </div>
      <div class="board-wrap"><div id="board" class="board"></div></div>
      <div class="footer">Controls: Click/Tap = reveal ‚Ä¢ Right-click/long-press = flag ‚Ä¢ Double-tap/long-press number = chord</div>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="modal">
      <h2 id="resultTitle"></h2>
      <p id="resultBody"></p>
      <p id="resultScore" style="font-weight:700;color:#ffe066"></p>
      <div class="btnRow">
        <button id="btnRestart" class="btn">Play Again</button>
        <button id="btnShare" class="btn">Share Score</button>
      </div>
      <div style="margin-top:12px;text-align:left;background:#0a2244;padding:8px;border-radius:8px">
        <h3>üèÜ Top 10</h3>
        <ol id="lbList"></ol>
        <div id="lbStatus" style="font-size:12px;color:#bbb;display:none"></div>
      </div>
    </div>
  </div>

<script>
(()=>{
let rows=9, cols=9, mines=10;
let grid=[], revealed=[], mineSet=new Set();
let flags=0, safeRemaining=0;
let state="idle"; let startTime=null, timer=0, raf=null;
let firstClick=true;
let lastTap=0, touchTimer=null;

const board=document.getElementById("board");
const timeEl=document.getElementById("time");
const flagsEl=document.getElementById("flags");
const remainingEl=document.getElementById("remaining");
const diffSel=document.getElementById("difficulty");

function setDifficulty(tag){
  if(tag==="b"){ cols=9; rows=9; mines=10; }
  else if(tag==="i"){ cols=16; rows=16; mines=40; }
  else if(tag==="e"){ cols=30; rows=16; mines=99; }
}

function initBoard(){
  setDifficulty(diffSel.value);
  grid=Array.from({length:rows},()=>Array(cols).fill(0));
  revealed=Array.from({length:rows},()=>Array(cols).fill(false));
  mineSet.clear(); flags=0; safeRemaining=rows*cols-mines; state="playing"; timer=0;
  firstClick=true;
  board.style.gridTemplateColumns=`repeat(${cols},var(--tile))`;
  board.innerHTML="";
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell=document.createElement("div");
      cell.className="cell hidden"; cell.dataset.r=r; cell.dataset.c=c;
      // Desktop
      cell.addEventListener("click",()=>reveal(r,c));
      cell.addEventListener("contextmenu",(e)=>{e.preventDefault();toggleFlag(r,c);});
      cell.addEventListener("mousedown",()=>cell.classList.add("pressed"));
      cell.addEventListener("mouseup",()=>cell.classList.remove("pressed"));
      cell.addEventListener("mouseleave",()=>cell.classList.remove("pressed"));
      // Mobile
      cell.addEventListener("touchstart",(e)=>{
        e.preventDefault();
        cell.classList.add("pressed");
        touchTimer=setTimeout(()=>{
          if(revealed[r][c]) mobileChord(r,c);
          else toggleFlag(r,c);
          touchTimer=null;
        },500);
      },{passive:false});
      cell.addEventListener("touchend",(e)=>{
        e.preventDefault();
        cell.classList.remove("pressed");
        if(touchTimer){
          clearTimeout(touchTimer);
          touchTimer=null;
          const now=Date.now();
          if(now-lastTap<300){
            if(revealed[r][c] && grid[r][c]>0){ mobileChord(r,c); lastTap=0; return; }
          }
          lastTap=now;
          reveal(r,c);
        }
      },{passive:false});
      board.appendChild(cell);
    }
  }
  updateUI();
}

function placeMines(excludeR,excludeC){
  let spots=[];
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(Math.abs(r-excludeR)<=1 && Math.abs(c-excludeC)<=1) continue;
      spots.push([r,c]);
    }
  }
  for(let i=spots.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [spots[i],spots[j]]=[spots[j],spots[i]];
  }
  for(let i=0;i<mines;i++){
    const [r,c]=spots[i];
    mineSet.add(r+","+c);
  }
}

function calculateCounts(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(mineSet.has(r+","+c)) continue;
      let count=0;
      for(const [nr,nc] of neighbors(r,c)){ if(mineSet.has(nr+","+nc)) count++; }
      grid[r][c]=count;
    }
  }
}

function neighbors(r,c){
  const result=[];
  for(let dr=-1;dr<=1;dr++){
    for(let dc=-1;dc<=1;dc++){
      if(dr===0&&dc===0) continue;
      const nr=r+dr,nc=c+dc;
      if(nr>=0&&nr<rows&&nc>=0&&nc<cols) result.push([nr,nc]);
    }
  }
  return result;
}

function at(r,c){ return board.children[r*cols+c]; }

function reveal(r,c){
  if(state!=="playing") return;
  if(firstClick){
    placeMines(r,c);
    calculateCounts();
    startTimer();
    firstClick=false;
    if(grid[r][c]===0){ floodReveal(r,c); return; }
  }
  if(revealed[r][c] && grid[r][c]>0){
    mobileChord(r,c);
    return;
  }
  if(revealed[r][c]) return;
  const cell=at(r,c);
  revealed[r][c]=true;
  cell.classList.remove("hidden");
  cell.classList.add("revealed");
  if(mineSet.has(r+","+c)){ cell.classList.add("mine"); gameOver(false); return; }
  safeRemaining--;
  if(grid[r][c]>0){ cell.textContent=grid[r][c]; cell.classList.add("num"+grid[r][c]); }
  else floodReveal(r,c);
  updateUI();
  if(safeRemaining===0) gameOver(true);
  else autoFlagIfDone();
}

function floodReveal(r,c){
  const stack=[[r,c]];
  while(stack.length){
    const [cr,cc]=stack.pop();
    if(cr<0||cr>=rows||cc<0||cc>=cols) continue;
    if(revealed[cr][cc]) continue;
    revealed[cr][cc]=true;
    const cell=at(cr,cc);
    cell.classList.remove("hidden"); cell.classList.add("revealed");
    const n=grid[cr][cc];
    if(n>0){ cell.textContent=n; cell.classList.add("num"+n); }
    else for(const [nr,nc] of neighbors(cr,cc)) stack.push([nr,nc]);
  }
}

function toggleFlag(r,c,force=false){
  if(state!=="playing"||revealed[r][c]) return;
  const cell=at(r,c);
  if(force){
    if(!cell.classList.contains("flag")){
      cell.classList.add("flag"); cell.textContent="üö©"; flags++; updateUI();
    }
    return;
  }
  if(cell.classList.contains("flag")){ cell.classList.remove("flag"); cell.textContent=""; flags--; }
  else{ cell.classList.add("flag"); cell.textContent="üö©"; flags++; }
  updateUI();
}

function mobileChord(r,c){
  if(!revealed[r][c]||grid[r][c]<=0) return;
  const neigh=neighbors(r,c);
  const flagCount=neigh.filter(([nr,nc])=>at(nr,nc).classList.contains("flag")).length;
  if(flagCount===grid[r][c]){
    at(r,c).classList.add("chorded");
    setTimeout(()=>at(r,c).classList.remove("chorded"),300);
    for(const [nr,nc] of neigh){
      if(!revealed[nr][nc]&&!at(nr,nc).classList.contains("flag")) reveal(nr,nc);
    }
  }
}

function autoFlagIfDone(){
  const unrevealed=[];
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    if(!revealed[r][c]&&!at(r,c).classList.contains("flag")) unrevealed.push([r,c]);
  }
  const unflaggedMines=mines-flags;
  if(unrevealed.length===unflaggedMines){
    for(const [r,c] of unrevealed) toggleFlag(r,c,true);
  }
}

function updateUI(){ timeEl.textContent=timer.toFixed(1); flagsEl.textContent=flags; remainingEl.textContent=safeRemaining; }
function startTimer(){ startTime=performance.now(); function step(now){ timer=(now-startTime)/1000; updateUI(); if(state==="playing") raf=requestAnimationFrame(step);} raf=requestAnimationFrame(step);}
function stopTimer(){ cancelAnimationFrame(raf); }

function gameOver(win){
  state="dead"; stopTimer();
  document.getElementById("resultTitle").textContent=win?"You Win! üò∫":"Boom! üêæ";
  const finalScore=win?Math.max(1,Math.round(10000/timer)):0;
  document.getElementById("resultBody").textContent=win?`Cleared in ${timer.toFixed(1)}s`:"You hit a mine!";
  document.getElementById("resultScore").textContent=`üèÜ Score: ${finalScore}`;
  document.getElementById("overlay").classList.add("show");
  saveScore(finalScore); loadLeaderboard();
}

// === Telegram Score API ===
function saveScore(finalScore){
  const params=new URLSearchParams(location.search);
  if(!params.get("uid")) return;
  fetch("https://chilledcatbot-server.onrender.com/score",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({uid:params.get("uid"),chat_id:params.get("chat_id"),message_id:params.get("message_id"),score:finalScore})
  }).then(()=>{if(window.TelegramGameProxy) TelegramGameProxy.shareScore();});
}
window.addEventListener("beforeunload",()=>saveScore(timer?Math.max(1,Math.round(10000/timer)):0));

function loadLeaderboard(){
  const list=document.getElementById("lbList"); const status=document.getElementById("lbStatus");
  list.innerHTML=""; status.style.display="block"; status.textContent="Loading‚Ä¶";
  const params=new URLSearchParams(location.search);
  fetch("https://chilledcatbot-server.onrender.com/highscores",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({uid:params.get("uid"),chat_id:params.get("chat_id"),message_id:params.get("message_id")})
  }).then(r=>r.json()).then(data=>{
    status.style.display="none";
    const items=(data&&data.result)?data.result.slice(0,10):[];
    if(!items.length){ list.innerHTML="<li>No scores yet</li>"; return; }
    for(const e of items){
      const li=document.createElement("li");
      li.textContent=`${(e.user?.first_name||"Player")} ‚Äî ${e.score}`;
      list.appendChild(li);
    }
  }).catch(()=>{status.textContent="Error loading leaderboard";});
}

// === Buttons ===
document.getElementById("newGame").onclick=()=>initBoard();
diffSel.onchange=()=>initBoard();
document.getElementById("btnRestart").onclick=()=>{document.getElementById("overlay").classList.remove("show");initBoard();};
document.getElementById("btnShare").onclick=()=>{if(window.TelegramGameProxy) TelegramGameProxy.shareScore();};

// === Start ===
initBoard();
})();
</script>
</body>
</html>
