<!DOCTYPE html>
<!--
/**
 *
 *    _______   .---.  .---..-./`)   .---.     .---.       .-''-.   ______     
 *   /   __  \  |   |  |_ _|\ .-.')  | ,_|     | ,_|     .'_ _   \ |    _ `''. 
 *  | ,_/  \__) |   |  ( ' )/ `-' \,-./  )   ,-./  )    / ( ` )   '| _ | ) _  \
 *,-./  )       |   '-(_{;}_)`-'`"`\  '_ '`) \  '_ '`) . (_ o _)  ||( ''_'  ) |
 *\  '_ '`)     |      (_,_) .---.  > (_)  )  > (_)  ) |  (_,_)___|| . (_) `. |
 * > (_)  )  __ | _ _--.   | |   | (  .  .-' (  .  .-' '  \   .---.|(_    ._) '
 *(  .  .-'_/  )|( ' ) |   | |   |  `-'`-'|___`-'`-'|___\  `-'    /|  (_.\.' / 
 * `-'`-'     / (_{;}_)|   | |   |   |        \|        \\       / |       .'  
 *   `._____.'  '(_,_) '---' '---'   `--------``--------` `'-..-'  '-----'`    
 *                                                                           
 *                   +=*          ***	    _______      ____   ,---------. 			              
 *                  *:::*        *=.:*	   /   __  \   .'  __ `.\          \	             
 *                 *.::::+      *:.:::*     | ,_/  \__) /   '  \  \`--.  ,---'         
 *                 +....+*++**++::::::=*  ,-./  )       |___|  /  |   |   \       
 *               *+++=:.:::::.:..:.::::*  \  '_ '`)        _.-`   |   :_ _:            
 *                ++++=--=+=-+:=+++++++=+  > (_)  )  __ .'   _    |   (_I_)        
 *               *:+..##.:++::+++***=++*  (  .  .-'_/  )|  _( )_  |  (_(=)_)   
 *               *..*....-+:::++..#:..=+   `-'`-'     / \ (_ o _) /   (_I_)   
 *               *........+::.+.:++*+..*     `._____.'   '.(_,_).'    '---'
 *               *...*+:.:::::-....:...+           
 *               *....*....:=.....::...**:**=*     
 *               *.....+=...+...-:....-*::+=:+*-*  
 *                +....+**+**+****.:=+*+.=*:=*.:*  
 *              **+....=-:####%:+...*.+::::.*=:*   
 *           *:..=*++=..:+=:::=*....*...*::..:*    
 *         *+.:+......:+.......:+*-:=+.......*     
 *         *.=-........:=............:+:...:**     [ chilled cat warez ]       /\_/\         
 *        *:-=...=...*.++.............*::::*.*     nfo: vibes ‚Ä¢ meow ‚Ä¢ zzz    ( o.o )        
 *        *.*....*::.**:.............*-.:::+.*     rel: 1997 // TON forever    > ^ <         
 *        *:=....=**+:...........::..*.....+:*     
 *        **.....+*::=+::.::.....:*:**..:..+:*     
 *        **.....+:-+*:.:+::::**:-=::+.....+:*     
 *
 * =====================================================
 *  CatSweeper '97 - Chilled Cat Minesweeper
 *   Version: 1.0.0
 *   Date: 2025-10-01
 *   Author: Chilled Cat Team
 *  
 *   Changelog:
 *   v 1.0.0 - Ported to Telegram
 * =====================================================
 */
-->

<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>CatSweeper ‚Äô97 ‚Äî Chilled Cat Minesweeper</title>
<link rel="preload" as="image" href="./images/premium_sticker1.webp">
<link rel="preload" as="image" href="./images/premium_sticker2.webp">
<link rel="preload" as="image" href="./images/premium_sticker3.webp">
<link rel="preload" as="image" href="./images/premium_sticker4.webp">
<style>
  :root{ --tile: 28px; --gap: 2px; --bg1:#0b2a52; --bg2:#081e3b; --edge:#9cf; --accent:#ffe066; --good:#3cff87; --bad:#ff5d73; }
  html,body{height:100%}
  body{margin:0; background:radial-gradient(1200px 600px at 10% 10%, #163258 0%, #0a1a2f 60%, #071324 100%); color:#fff; font-family:Verdana, Tahoma, Arial, sans-serif;}
  .wrap{max-width:980px; margin:12px auto; padding:10px}
  .card{background:linear-gradient(var(--bg1), var(--bg2)); border:4px ridge var(--edge); border-radius:8px; box-shadow:0 18px 50px rgba(0,0,0,.5)}
  .titlebar{display:flex; align-items:center; gap:10px; padding:8px 10px; background:linear-gradient(#0049a1,#002d6b); border-bottom:3px groove #8ad}
  .titlebar .led{width:10px;height:10px;border-radius:50%;background:#3cff87;box-shadow:0 0 8px #3cff87}
  .titlebar h1{margin:0;font-size:18px}
  .panel{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:8px 10px}
  .group{display:flex;align-items:center;gap:10px}
  .btn{border:3px outset #bdf;background:#0d5bd1;color:#fff;padding:6px 12px;cursor:pointer;border-radius:6px;font-weight:800}
  .btn:active{border-style:inset}
  .stat{font-weight:700}
  .stat b{color:var(--accent)}
  .board-wrap{padding:10px;display:grid;place-items:center}
  .board{display:grid;gap:var(--gap);background:#001d3d;padding:var(--gap);border:4px groove var(--edge);border-radius:6px;user-select:none}
  .cell{width:var(--tile);height:var(--tile);display:grid;place-items:center;font-weight:800;font-size:14px;line-height:1;border-radius:4px;cursor:pointer;transition:transform .05s}
  .cell.hidden{background:#0f3a75;border:2px outset #a9d2ff}
  .cell.hidden:active{transform:translateY(1px)}
  .cell.revealed{background:#0a2244;border:2px inset #7fb5ff;cursor:default}
  .cell.flag{background:#0e315f;border:2px inset #9cc9ff}
  .cell.mine{background:#3b0a1b;border:2px inset #ff98a9}
  .num1{color:#7effad}.num2{color:#b1e3ff}.num3{color:#ffd18d}.num4{color:#ff9aa2}
  .num5{color:#ffa3ff}.num6{color:#c4ffd9}.num7{color:#fff}.num8{color:#d6e2ff}
  .mine-icon{width:80%;height:80%;object-fit:contain;image-rendering:auto;filter:drop-shadow(0 1px 0 rgba(0,0,0,.6))}
  .flag-icon{font-size:16px}
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,12,22,.76)}
  .overlay.show{display:grid}
  .modal{background:linear-gradient(var(--bg1), var(--bg2));border:4px ridge var(--edge);border-radius:10px;padding:16px 18px;text-align:center;width:min(92vw,420px)}
  .good{color:var(--good)}.bad{color:var(--bad)}
  .result-img{display:block;max-width:140px;margin:8px auto;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.6)}
  .footer{padding:8px 10px;text-align:center;font-size:12px;opacity:.9}
  .lb{margin:10px;background:#082041;border:1px solid #2c4d82;border-radius:10px;padding:10px;text-align:left}
  .lb h3{margin:0 0 6px;font-size:16px}
  .lb ol{margin:0;padding-left:22px}
  .muted{color:#bcd;font-size:13px}
  .diag{padding:6px 10px;font-size:12px;opacity:.85}
  .diag b{color:#ffcc77}
  @media (max-width:520px){ :root{ --tile: 26px; } }
</style>
<script src="https://download.playfab.com/PlayFabClientApi.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="titlebar"><div class="led"></div><h1>üêæ CatSweeper ‚Äô97 ‚Äî Chilled Cat Minesweeper</h1></div>
      <div class="panel">
        <div class="group">
          <button class="btn" id="newGame">New Game</button>
          <span class="muted">Beginner 9√ó9 ¬∑ 10 mines</span>
        </div>
        <div class="group">
          <div class="stat">‚è±Ô∏è Time: <b id="time">0.0</b>s</div>
          <div class="stat">üòº Safe: <b id="remaining">0</b></div>
          <div class="stat">üèÅ Flags: <b id="flags">0</b></div>
          <div class="stat" title="Best local time">üèÜ Best: <b id="best">‚Äî</b></div>
        </div>
      </div>
      <div class="board-wrap">
        <div id="board" class="board" aria-label="Minesweeper board" role="grid"></div>
      </div>
      <div class="footer">Tap = reveal ‚Ä¢ Long-press/right-click = flag ‚Ä¢ Press <kbd>R</kbd> to restart</div>
      <div id="diag" class="diag" style="display:none"></div>
    </div>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="resultTitle">You win!</h2>
      <img id="resultImage" class="result-img" src="" alt="Chilled Cat" style="display:none;">
      <p id="resultBody">Nice and chilly.</p>
      <div class="lb">
        <h3>üèÜ Top 10</h3>
        <ol id="lbList"></ol>
        <div id="lbStatus" class="muted" style="display:none"></div>
      </div>
      <button class="btn" id="again">Play Again</button>
    </div>
  </div>

<script>
/* =====================================================
   Telegram Web + PlayFab wiring (same style as Flappy Cat)
   - Reads ?uid, ?username, ?contest
   - Logs in to PlayFab (TitleId below)
   - Saves score: score = floor(100000 / timeMs)  (bigger = better)
   - Global stat name: "CatSweeperScore"
   - Contest stat name: contestKey (from URL param)
   - Shows Top 10 on game over
   ===================================================== */
(function(){
  const params = new URLSearchParams(location.search);
  const uid = params.get("uid") || crypto.randomUUID();
  const username = params.get("username") || "Anonymous";
  const contestKey = params.get("contest"); // if present, use contest leaderboard
  const playFabTitleId = "B4195"; // same as your Flappy Cat example
  PlayFab.settings.titleId = playFabTitleId;

  // Login + set display name (best-effort)
PlayFabClientSDK.LoginWithCustomID({
  TitleId: playFabTitleId,
  CustomId: uid,
  CreateAccount: true
}, () => {
  PlayFabClientSDK.UpdateUserTitleDisplayName({
    DisplayName: username
  }, res => {
    console.log("‚úÖ DisplayName set:", res.data.DisplayName);
    initGame();
  }, err => {
    if (err.error === "NameNotAvailable") {
      const fallback = (username || "Player") + "_" + uid.slice(-4);
      PlayFabClientSDK.UpdateUserTitleDisplayName({
        DisplayName: fallback
      }, () => initGame(), () => initGame());
    } else {
      initGame();
    }
  });
}, () => initGame());

  /* ========= Game logic (9x9 fixed) ========= */
  function initGame(){
    // Stickers verify (same as your version)
    const DIAG = document.getElementById('diag');
    const FALLBACK_DATA_URI = "data:image/svg+xml;utf8,"+
      encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#163258'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-family='Verdana' font-size='28' fill='#fff'>üò∫</text></svg>`);
    const defaults = [
      './images/premium_sticker1.webp',
      './images/premium_sticker2.webp',
      './images/premium_sticker3.webp',
      './images/premium_sticker4.webp'
    ];
    let AVAILABLE = [];
    let MISSING = [];
    function preloadAndVerify(src){
      return new Promise(resolve=>{
        const im = new Image();
        im.onload = ()=> resolve({src, ok:true});
        im.onerror = ()=> resolve({src, ok:false});
        im.src = src;
      });
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function updateDiag(){
      if(MISSING.length){
        DIAG.style.display = 'block';
        DIAG.innerHTML = `‚ö†Ô∏è Some sticker images failed to load.<br><b>Missing</b>:<br><code>${MISSING.map(x=>escapeHtml(x)).join('<br>')}</code>`;
      } else {
        DIAG.style.display = 'none';
        DIAG.textContent='';
      }
    }
    Promise.all(defaults.map(preloadAndVerify)).then(list=>{
      AVAILABLE = list.filter(r=>r.ok).map(r=>r.src);
      MISSING = list.filter(r=>!r.ok).map(r=>r.src);
      if(!AVAILABLE.length) AVAILABLE = [FALLBACK_DATA_URI];
      updateDiag();
    });

    // DOM refs
    const boardEl = document.getElementById('board');
    const timeEl = document.getElementById('time');
    const remainingEl = document.getElementById('remaining');
    const flagsEl = document.getElementById('flags');
    const bestEl = document.getElementById('best');
    const newBtn = document.getElementById('newGame');
    const overlay = document.getElementById('overlay');
    const againBtn = document.getElementById('again');
    const resultTitle = document.getElementById('resultTitle');
    const resultBody = document.getElementById('resultBody');
    const resultImage = document.getElementById('resultImage');
    const lbList = document.getElementById('lbList');
    const lbStatus = document.getElementById('lbStatus');

    // Fixed beginner
    let cols=9, rows=9, mines=10;
    let firstReveal = true; let timer=0, raf=null, running=false; let flags=0, safeRemaining=0;
    let grid=[], revealed=[], flagged=[], counts=[], minesSet=new Set();

    function key(r,c){ return r+','+c; }
    function inBounds(r,c){ return r>=0 && r<rows && c>=0 && c<cols; }
    function forNeighbors(r,c,fn){ for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++) if(dr||dc){ const nr=r+dr,nc=c+dc; if(inBounds(nr,nc)) fn(nr,nc); } }
    function cssCols(){ boardEl.style.setProperty('grid-template-columns', `repeat(${cols}, var(--tile))`); }

    function resetState(){
      grid = Array.from({length: rows}, () => Array(cols).fill(0));
      counts = Array.from({length: rows}, () => Array(cols).fill(0));
      revealed = Array.from({length: rows}, () => Array(cols).fill(false));
      flagged = Array.from({length: rows}, () => Array(cols).fill(false));
      minesSet.clear(); firstReveal = true; flags = 0; running=false; timer=0; updateTimer();
      safeRemaining = rows*cols - mines; updateCounters();
    }
    function placeMines(excludeR, excludeC){
      const spots=[];
      for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
        if(Math.abs(r-excludeR)<=1 && Math.abs(c-excludeC)<=1) continue;
        spots.push({r,c});
      }
      for(let i=spots.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [spots[i],spots[j]]=[spots[j],spots[i]]; }
      for(let i=0;i<mines && i<spots.length;i++){ const {r,c}=spots[i]; grid[r][c]=1; minesSet.add(key(r,c)); }
      for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) if(!grid[r][c]){ let n=0; forNeighbors(r,c,(nr,nc)=>{ if(grid[nr][nc]) n++; }); counts[r][c]=n; }
    }
    function buildBoard(){
      boardEl.innerHTML=''; cssCols();
      const frag = document.createDocumentFragment();
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell=document.createElement('div');
          cell.className='cell hidden';
          cell.setAttribute('role','gridcell');
          cell.setAttribute('aria-label','hidden');
          cell.dataset.r=r; cell.dataset.c=c;
          frag.appendChild(cell);
        }
      }
      boardEl.appendChild(frag);
    }

    function updateTimer(){ timeEl.textContent = timer.toFixed(1); }
    function updateCounters(){ remainingEl.textContent = safeRemaining; flagsEl.textContent = flags; bestEl.textContent = bestTimeLabel(); }
    function startTimer(){ if(running) return; running=true; function step(now){ timer += (now - (step.last||now))/1000; step.last=now; updateTimer(); if(running) raf=requestAnimationFrame(step); } raf=requestAnimationFrame(step); }
    function stopTimer(){ running=false; cancelAnimationFrame(raf); }

    function reveal(r,c){
      if(!inBounds(r,c) || revealed[r][c] || flagged[r][c]) return;
      if(firstReveal){ placeMines(r,c); firstReveal=false; startTimer(); }
      const cellEl = at(r,c);
      revealed[r][c]=true; cellEl.classList.remove('hidden'); cellEl.classList.add('revealed'); cellEl.setAttribute('aria-label','revealed');
      if(grid[r][c]){ showMine(cellEl); gameOver(false); return; }
      safeRemaining--; updateCounters();
      const n = counts[r][c];
      if(n>0){ cellEl.textContent=n; cellEl.classList.add('num'+n); }
      else{ forNeighbors(r,c,(nr,nc)=>{ reveal(nr,nc); }); }
      autoOpenAround(r,c);
      if(safeRemaining===0) gameOver(true);
    }
    function autoOpenAround(r,c){
      const n = counts[r][c]; if(!revealed[r][c] || n===0) return;
      let f=0; forNeighbors(r,c,(nr,nc)=>{ if(flagged[nr][nc]) f++; });
      if(f===n){ forNeighbors(r,c,(nr,nc)=>{ if(!flagged[nr][nc]) reveal(nr,nc); }); }
    }
    function toggleFlag(r,c){
      if(!inBounds(r,c) || revealed[r][c]) return;
      const cellEl = at(r,c);
      flagged[r][c] = !flagged[r][c];
      if(flagged[r][c]){ flags++; cellEl.classList.add('flag'); cellEl.innerHTML = '<span class="flag-icon">üö©</span>'; cellEl.setAttribute('aria-label','flag'); }
      else { flags--; cellEl.classList.remove('flag'); cellEl.textContent=''; cellEl.setAttribute('aria-label','hidden'); }
      updateCounters();
    }
    function showMine(cellEl){
      cellEl.classList.add('mine'); cellEl.innerHTML='';
      const im = document.createElement('img'); im.className='mine-icon';
      const pick = (AVAILABLE.length ? AVAILABLE[(Math.random()*AVAILABLE.length)|0] : FALLBACK_DATA_URI);
      im.src = pick; im.alt='Chilled Cat';
      im.onerror = () => { cellEl.textContent='üò∫'; };
      cellEl.appendChild(im);
    }
    function revealAllMines(){
      minesSet.forEach(id=>{
        const [r,c]=id.split(',').map(Number);
        const el=at(r,c);
        if(!revealed[r][c]){
          revealed[r][c]=true;
          el.classList.remove('hidden'); el.classList.add('revealed');
          showMine(el);
        }
      });
    }
    function at(r,c){ return boardEl.children[r*cols + c]; }

    function bestKey(){ return `catsweeper_best_9x9x10`; }
    function bestTimeLabel(){ const v = +localStorage.getItem(bestKey()); return v ? v.toFixed(1)+'s' : '‚Äî'; }
    function recordBest(){ const k = bestKey(); const prev = +localStorage.getItem(k) || Infinity; if(timer < prev){ localStorage.setItem(k, String(timer)); } }

    function gameOver(win){
      stopTimer(); if(!win) revealAllMines();
      resultTitle.textContent = win ? 'You win! üò∫' : 'Boom! üêæ';
      resultTitle.className = win ? 'good' : 'bad';
      resultBody.textContent = win ? `Cleared in ${timer.toFixed(1)}s` : 'A horde of chilled cats overran the board!';

      // popup image
      const pick = (AVAILABLE.length ? AVAILABLE[(Math.random()*AVAILABLE.length)|0] : FALLBACK_DATA_URI);
      resultImage.src = pick;
      resultImage.style.display = 'block';
      resultImage.onerror = () => { resultImage.style.display = 'none'; };

      if(win) { recordBest(); updateCounters(); }

// Save score to PlayFab (higher = better)
const timeMs = Math.max(1, Math.round(timer * 1000));
const score = Math.floor(100000 / timeMs);

PlayFabClientSDK.GetPlayerStatistics({}, res => {
  const prev = res.data.Statistics.find(s => s.StatisticName === "CatSweeperScore")?.Value || 0;
  const statsToSave = [];

  // Update if new score is better
  if (score > prev) {
    statsToSave.push({ StatisticName:"CatSweeperScore", Value: score });
  }

  // Contest leaderboard (if active)
  if (contestKey) {
    const prevContest = res.data.Statistics.find(s => s.StatisticName === contestKey)?.Value || 0;
    if (score > prevContest) {
      statsToSave.push({ StatisticName: contestKey, Value: score });
    }
  }

  if (statsToSave.length > 0) {
    PlayFabClientSDK.UpdatePlayerStatistics({ Statistics: statsToSave }, () => {
      console.log("‚úÖ Scores saved:", statsToSave);
      renderLeaderboard();
    }, err => {
      console.error("‚ùå Error saving score:", err);
      renderLeaderboard();
    });
  } else {
    console.log("‚ÑπÔ∏è Score not higher, skipping update");
    renderLeaderboard();
  }
}, err => {
  console.error("‚ùå Could not fetch player stats", err);
  renderLeaderboard();
});


      overlay.classList.add('show');
    }

    function renderLeaderboard(){
      lbList.innerHTML = ""; lbStatus.style.display = "block"; lbStatus.textContent = "Loading‚Ä¶";
      const statName = contestKey ? contestKey : "CatSweeperScore";
      PlayFabClientSDK.GetLeaderboard({
        StatisticName: statName,
        StartPosition: 0,
        MaxResultsCount: 10
      }, res => {
        lbStatus.style.display = "none";
        lbList.innerHTML = "";
        const rows = res?.data?.Leaderboard || [];
        if (!rows.length){
          lbList.innerHTML = "<li>No scores yet</li>";
          return;
        }
        rows.forEach((entry, idx) => {
          const name = entry.DisplayName && !/^\d+$/.test(entry.DisplayName) ? entry.DisplayName : "Anonymous";
          const score = entry.StatValue|0;
          // Reconstruct approximate time for display: timeMs ‚âà floor(100000 / score)
          const timeMs = score > 0 ? Math.floor(100000 / score) : 0;
          const secs = (timeMs/1000).toFixed(1);
          const li = document.createElement("li");
          li.textContent = `${idx+1}. ${name} ‚Äî ${secs}s`;
          lbList.appendChild(li);
        });
      }, err => {
        lbStatus.textContent = "‚ùå Error loading leaderboard";
        console.error("Leaderboard error:", err);
      });
    }

    function newGame(){
      resetState(); buildBoard(); updateCounters();
      resultImage.style.display = 'none';
      overlay.classList.remove('show');
    }

    // Events (tap/long-press/right-click)
    boardEl.addEventListener('contextmenu', e=>{ e.preventDefault(); });
    boardEl.addEventListener('mousedown', (e)=>{
      const cell = e.target.closest('.cell'); if(!cell) return;
      const r=+cell.dataset.r,c=+cell.dataset.c;
      if(e.button===2) toggleFlag(r,c); else if(e.button===0) reveal(r,c);
    });
    let touchTimer=null, touchCell=null;
    boardEl.addEventListener('touchstart',(e)=>{
      const cell = e.target.closest('.cell'); if(!cell) return; e.preventDefault();
      touchCell = cell;
      touchTimer = setTimeout(()=>{
        const r=+cell.dataset.r,c=+cell.dataset.c; toggleFlag(r,c); touchTimer=null;
      }, 420);
    }, {passive:false});
    boardEl.addEventListener('touchend',(e)=>{
      e.preventDefault();
      const cell = touchCell; if(!cell) return;
      const r=+cell.dataset.r,c=+cell.dataset.c;
      if(touchTimer){ clearTimeout(touchTimer); touchTimer=null; reveal(r,c); }
      touchCell=null;
    }, {passive:false});

    newBtn.addEventListener('click', newGame);
    againBtn.addEventListener('click', newGame);
    window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='r'){ newGame(); } });

    // init
    newGame();
  }
})();
</script>
</body>
</html>
