<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CatSweeper ‚Äô97 ‚Äî Chilled Cat Minesweeper</title>
<style>
  body{margin:0;background:#0a1a2f;color:#fff;font-family:Verdana,sans-serif;text-align:center}
  #board{display:grid;gap:2px;justify-content:center;margin:20px auto}
  .cell{width:28px;height:28px;display:flex;align-items:center;justify-content:center;
        border:2px outset #7fb5ff;background:#0f3a75;color:#fff;font-weight:800;cursor:pointer}
  .cell.revealed{background:#0a2244;border:2px inset #7fb5ff;cursor:default}
  .cell.mine{background:#3b0a1b}
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.75)}
  .overlay.show{display:grid}
  .panel{background:#163258;padding:20px;border-radius:10px;width:90%;max-width:400px}
  .btn{background:#0d5bd1;color:#fff;padding:8px 14px;border:none;border-radius:6px;font-weight:700;cursor:pointer}
  .btn:active{background:#094095}
  ol{padding-left:20px;text-align:left}
</style>
<script src="https://telegram.org/js/games.js"></script>
</head>
<body>
  <h1>üêæ CatSweeper ‚Äô97</h1>
  <div id="board"></div>

  <div id="overlay" class="overlay">
    <div class="panel">
      <h2 id="resultTitle"></h2>
      <p id="resultBody"></p>
      <p id="resultScore" style="font-weight:700;color:#ffe066"></p>
      <button id="btnRestart" class="btn">Play Again</button>
      <button id="btnShare" class="btn">Share Score</button>
      <div style="margin-top:12px;text-align:left;background:#0a2244;padding:8px;border-radius:8px">
        <h3>üèÜ Top 10</h3>
        <ol id="lbList"></ol>
        <div id="lbStatus" style="font-size:12px;color:#bbb;display:none"></div>
      </div>
    </div>
  </div>

<script>
(()=>{
// === Config ===
const rows=9, cols=9, mines=10;
let grid=[], revealed=[], mineSet=new Set();
let safeRemaining=rows*cols-mines;
let state="playing";
let startTime=null, timer=0, raf=null;
const board=document.getElementById("board");
board.style.gridTemplateColumns=`repeat(${cols},28px)`;

// === Score helpers ===
function saveScore(finalScore){
  const params=new URLSearchParams(location.search);
  if(!params.get("uid")) return;
  try{
    fetch("https://chilledcatbot-server.onrender.com/score",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        uid:params.get("uid"),
        chat_id:params.get("chat_id"),
        message_id:params.get("message_id"),
        score:finalScore
      })
    }).then(()=>{
      if(window.TelegramGameProxy) TelegramGameProxy.shareScore();
    });
  }catch(e){ console.error("saveScore",e); }
}
window.addEventListener("beforeunload",()=>saveScore(timer?Math.max(1,Math.round(10000/timer)):0));

// === Leaderboard ===
function loadLeaderboard(){
  const list=document.getElementById("lbList");
  const status=document.getElementById("lbStatus");
  list.innerHTML=""; status.style.display="block"; status.textContent="Loading‚Ä¶";
  const params=new URLSearchParams(location.search);
  fetch("https://chilledcatbot-server.onrender.com/highscores",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      uid:params.get("uid"),
      chat_id:params.get("chat_id"),
      message_id:params.get("message_id")
    })
  })
  .then(r=>r.json())
  .then(data=>{
    status.style.display="none";
    const items=(data&&data.result)?data.result.slice(0,10):[];
    if(!items.length){ list.innerHTML="<li>No scores yet</li>"; return; }
    for(const e of items){
      const li=document.createElement("li");
      li.textContent=`${(e.user?.first_name||"Player")} ‚Äî ${e.score}`;
      list.appendChild(li);
    }
  })
  .catch(()=>{status.textContent="Error loading leaderboard";});
}

// === Timer ===
function startTimer(){
  startTime=performance.now();
  function step(now){
    timer=(now-startTime)/1000;
    if(state==="playing") raf=requestAnimationFrame(step);
  }
  raf=requestAnimationFrame(step);
}
function stopTimer(){ cancelAnimationFrame(raf); }

// === Game logic ===
function initBoard(){
  grid=Array.from({length:rows},()=>Array(cols).fill(0));
  revealed=Array.from({length:rows},()=>Array(cols).fill(false));
  mineSet.clear(); safeRemaining=rows*cols-mines; state="playing"; timer=0;
  board.innerHTML="";
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell=document.createElement("div");
      cell.className="cell"; cell.dataset.r=r; cell.dataset.c=c;
      cell.addEventListener("click",()=>reveal(r,c));
      board.appendChild(cell);
    }
  }
  placeMines();
  startTimer();
}
function placeMines(){
  let spots=[]; for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) spots.push([r,c]);
  for(let i=0;i<mines;i++){
    const pick=spots.splice(Math.floor(Math.random()*spots.length),1)[0];
    mineSet.add(pick.join(","));
  }
}
function reveal(r,c){
  if(state!=="playing"||revealed[r][c]) return;
  const cell=at(r,c); revealed[r][c]=true;
  if(mineSet.has(r+","+c)){ cell.classList.add("mine"); gameOver(false); return; }
  cell.classList.add("revealed"); safeRemaining--;
  if(safeRemaining===0) gameOver(true);
}
function at(r,c){ return board.children[r*cols+c]; }

function gameOver(win){
  state="dead"; stopTimer();
  document.getElementById("resultTitle").textContent=win?"You Win! üò∫":"Boom! üêæ";
  const finalScore=win?Math.max(1,Math.round(10000/timer)):0; // ‚úÖ speed-based scoring
  document.getElementById("resultBody").textContent=win?`Cleared in ${timer.toFixed(1)}s`:"You hit a mine!";
  document.getElementById("resultScore").textContent=`üèÜ Score: ${finalScore}`;
  document.getElementById("overlay").classList.add("show");
  saveScore(finalScore);
  loadLeaderboard();
}

// === Buttons ===
document.getElementById("btnRestart").onclick=()=>{
  document.getElementById("overlay").classList.remove("show");
  initBoard();
};
document.getElementById("btnShare").onclick=()=>{
  if(window.TelegramGameProxy) TelegramGameProxy.shareScore();
};

// === Start ===
initBoard();
})();
</script>
</body>
</html>
